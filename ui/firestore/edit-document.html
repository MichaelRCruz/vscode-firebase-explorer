<!DOCTYPE html>
<html lang="en">
<script>
    // @ts-check
</script>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Function Log</title>
  <style>
    body {
      position: absolute;
      top: 0;
      bottom: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
    }

    #container {
      display: flex;
      flex-direction: column;
      height: 100%;
      color: var(--vscode-foreground);
      background-color: var(--vscode-editor-background);
    }

    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 5px;
      background-color: inherit;
      min-height: 38px;
      max-height: 38px;
    }

    code {
      font-family: 'Roboto Mono', monospace;
    }

    #contentWrapper {
      overflow: auto;
      display: flex;
    }

    /**********************************************/

    .wrap-collabsible {
      /* margin-bottom: 1.2rem; */
    }

    input[type='checkbox'] {
      display: none;
    }

    .lbl-toggle {
      display: block;
      font-family: monospace;
      text-align: start;
      /* color: #A77B0E; */
      cursor: pointer;
      border-radius: 7px;
      transition: all 0.25s ease-out;
    }

    .lbl-toggle:hover {
      /* color: #7C5A0B; */
    }

    .lbl-toggle::before {
      content: ' ';
      display: inline-block;

      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
      border-left: 5px solid currentColor;
      vertical-align: middle;
      margin-top: 0.25rem;
      margin-right: 0.5rem;
      transform: translateY(-2px);

      transition: transform 0.2s ease-out;
    }

    .toggle:checked+.lbl-toggle::before {
      transform: rotate(90deg) translateX(-3px);
    }

    .collapsible-content {
      max-height: 0px;
      overflow: hidden;
      transition: max-height 0.2s ease-in-out;
    }

    .toggle:checked+.lbl-toggle+.collapsible-content {
      max-height: 500px;
    }

    .toggle:checked+.lbl-toggle {
      border-bottom-right-radius: 0;
      border-bottom-left-radius: 0;
    }

    .collapsible-content .content-inner {
      padding: 0.1rem 1.2rem;
    }

    /*****************************/

    .tree {
      margin: 0 1rem;
    }

    .wrap-field {
      display: flex;
      justify-content: flex-start;
      margin-left: 0.78rem;
    }

    .wrap-field .field-name {
      font-family: monospace;
    }
  </style>

  <!-- <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons+Extended"> -->
</head>

<body>
  <div id="container">
    <div id="header">
      <div>
        Document: <code id="documentPath"></code>
      </div>
    </div>
    <div id="contentWrapper">
      <div>
        <!-- <form id="docForm">
        <ul class="flex-outer" id="docFormList"></ul>
      </form> -->
        <div class="tree" id="docFormList">
        </div>

        <br />

        <div id="container">
          <pre><code id="docjson"></code></pre>
        </div>
      </div>
    </div>
</body>
<script>
  let isLive = true;
  let disableTailOnScroll = true;
  let lastEntry = null;
  let activeExec = null;
  let entriesConter = 0;

  // @ts-ignore
  const vscode = acquireVsCodeApi();
  const docjson = document.querySelector('#docjson');
  const documentPath = document.querySelector('#documentPath');
  const docForm = document.querySelector('#docForm');
  const docFormList = document.querySelector('#docFormList');

  window.addEventListener('message', event => {
    const command = event.data.command;
    const data = event.data.data;

    switch (command) {
      case 'initialize':
        initialize(data);
        break;
    }
  });

  vscode.postMessage({
    command: 'ready'
  });

  function initialize(data) {
    documentPath.textContent = data.path;
    docjson.textContent = JSON.stringify(data.fields, null, 2);

    for (const fieldItem in data.fields) {
      const field = data.fields[fieldItem];

      docFormList.appendChild(newDOM(getFieldHTML(field)));
    }
  }

  function getFieldHTML(field) {
    if (field.type === 'array' || field.type === 'map') {
      return `
        <div class="wrap-collabsible">
          <input id="field-${escapeHtml(field.name)}" class="toggle" type="checkbox" checked>
          <label for="field-${escapeHtml(field.name)}" class="lbl-toggle">${escapeHtml(field.name)}</label>
          <div class="collapsible-content">
            <div class="content-inner">${
        field.value.map((arrayField, pos) => {
          return (field.type === 'array' ? `<span class="arrayPos">${pos}</span>` : '') + getFieldHTML(arrayField)
        }).join('')
        }  </div>
          </div>
        </div>
      `;
    } else {
      let escapedValue = escapeHtml(field.value);

      switch (field.type) {
        case 'string':
          escapedValue = `"${escapedValue}"`;
          break;
        case 'geopoint':
          // TODO
          break;
        case 'timestamp':
          // TODO
          break;
      }

      return `
        <div class="wrap-field">
          ${'name' in field ? `<div class="field-name">${escapeHtml(field.name)}</div>` : ''}
          <div class="fieldValue" field-type-${field.type}">${escapedValue}</div>
        </div>
      `;
    }
  }

  function escapeHtml(text) {
    return !text || typeof text !== 'string'
      ? text
      : text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
  }

  function newDOM(domString) {
    const html = new DOMParser().parseFromString(domString, 'text/html');
    return html.body.firstChild;
  };
</script>

</html>